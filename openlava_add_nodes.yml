---
- name: Setup new nodes in OpenLava cluster with docker support
  hosts: docker_openlava
  gather_facts: yes
  sudo: true

- name: Master node - update Openlava cluster with docker support
  hosts: docker_openlava_nodes
  tasks:
  - name: Master node - remove new nodes ip addresses from /etc/hosts file 
    lineinfile: 
      dest: /etc/hosts
      regexp: '^{{ hostvars[item].ansible_default_ipv4.address }}.*'
      state: absent
    with_items: 
      - '{{ groups.docker_openlava_nodes_new }}'
    when: inventory_hostname == groups['docker_openlava_nodes'][0]

  - name: Master node - add lines to /etc/hosts file
    lineinfile: 
      dest: /etc/hosts
      regexp: '.*{{ hostvars[item].ansible_hostname }}$'
      line: '{{ hostvars[item].ansible_default_ipv4.address }} {{ hostvars[item].ansible_hostname }}'
      backup: yes
    with_items: 
      - '{{ groups.docker_openlava_nodes_new }}'
    when: inventory_hostname == groups['docker_openlava_nodes'][0]

  - name: Master node - find openlava install dir
    shell: ls /opt | grep openlava
    register: openlava_dir
    when: inventory_hostname == groups['docker_openlava_nodes'][0]

  - set_fact: 
      openlava_dir: "/opt/{{ openlava_dir.stdout }}"
    when: inventory_hostname == groups['docker_openlava_nodes'][0]

  - name: Master node - execute lsaddhost command
    shell: "{{ openlava_dir }}/bin/lsaddhost {{ hostvars[item].ansible_hostname }} > /dev/null 2>&1"
    with_items: 
      - '{{ groups.docker_openlava_nodes_new }}'
    when: inventory_hostname == groups['docker_openlava_nodes'][0]
  sudo: true






