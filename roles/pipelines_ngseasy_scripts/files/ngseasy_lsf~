#!/usr/bin/env bash
set -o errexit

###########################################################################################
# Program: ngseasy_lsf
# Version 1.0-r001
# Author: Stephen Newhouse (stephen.j.newhouse@gmail.com); Amos Folarin (amosfolarin@gmail.com)
###########################################################################################
#
#    Copyright (C) 2015  Stephen Jeffrey Newhouse (bluecell.io)
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#
###########################################################################################

###########################################################################################
## global logging fuction
###########################################################################################

function logger_ngseasy() {
 message=${1}
 mylogfile=${2}
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]" >> ${mylogfile}.log;
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]"
}

###########################################################################################
## split function that adds header line
###########################################################################################
function split_config() {
 config_file=${1}
 tail -n +2 ${config_file} | split -l 1 - ${config_file}_

 for file in  ${config_file}_*
 do
     head -n 1 ${config_file} > tmp_file
     cat $file >> tmp_file
     mv -f tmp_file $file
 done
}

###########################################################################################
## default options
###########################################################################################

config_tsv=""
project_directory=""

###########################################################################################
## get options for command line args
###########################################################################################

while  getopts "hc:d:" opt
do

  case ${opt} in

   h)
   usage_ngseasy #print help
   exit 0
   ;;

   c)
   config_tsv=${OPTARG}
   echo -e "CONFIG FILE [-c] = ${config_tsv}"
   ;;

   d)
   project_directory=${OPTARG}
   echo -e  "PROJECT DIR [-d] = ${project_directory}"
   ;;

   esac
done

###########################################################################################
## Check options passed in.
###########################################################################################

if [[ -z "$config_tsv" ]]; then
    echo -e "\nERROR: No options were passed. Exiting"
    sleep 1s
	usage_ngseasy
	sleep 1s
	exit 1
fi

###########################################################################################
## Make log file ##
###########################################################################################

## strip path if user enters config with full path specified
configfile_name=`basename ${config_tsv}`

# set logile name and make it if it does not exist
config_run_log="${project_directory}/run_logs/ngseasy.${NGSEASYVERSION}.${configfile_name}.${RUNDATE}"

if [[ ! -e "${config_run_log}.log" ]]
then
	logger_ngseasy "[ngseasy]:Making log file [${config_run_log}.log]"

	touch ${config_run_log}.log

	logger_ngseasy "[ngseasy]:Log file [${config_run_log}.log]"

else
	logger_ngseasy "[ngseasy]:Log file [${config_run_log}.log]"

fi

###########################################################################################
## check ${project_directory} exists.
###########################################################################################
logger_ngseasy "[ngseasy]:Check if project dir [${project_directory}] exists"

if [[ ! -d "${project_directory}" ]]
  then
	  usage_ngseasy;
	  logger_ngseasy "[ngseasy]:ERROR:${project_directory} does not exist. Exiting."
	  sleep 2s
	  exit 1;
fi


###########################################################################################
## check config_tsv exists.
###########################################################################################

# find out where we are running from
my_current_dirctory=`pwd`

logger_ngseasy "[ngseasy]:Current working directory [${my_current_dirctory}]" ${config_run_log}
logger_ngseasy "[ngseasy]:Config file set as [${config_tsv}]" ${config_run_log}
sleep 1s

## check if user has used full path to specify config_tsv
# strip path if user enters config with full path specified
# and the move to the dir containing the config_tsv
#
config_directory_path=`dirname ${config_tsv}`

if [[ "${config_directory_path}" == "." ]]; then
	working_dir="${my_current_dirctory}"
	logger_ngseasy "[ngseasy]:Path to config file directory detected as [${working_dir}]" ${config_run_log}
	logger_ngseasy "[ngseasy]:Setting Path to config file" ${config_run_log}
	logger_ngseasy "[ngseasy]:Config file location set to [${working_dir}]" ${config_run_log}
	logger_ngseasy "[ngseasy]:Moving to Config file location [${working_dir}] to make life easy" ${config_run_log}

	# move to location of config file
	cd ${working_dir}

	# check if file exists
	configfile_name=`basename ${config_tsv}`

if [[ ! -e "./${configfile_name}" ]]; then
	logger_ngseasy "[ngseasy]:ERROR:Config file [${config_tsv}] does not exist. Exiting" ${config_run_log}
	sleep 1s
	exit 1
else
	logger_ngseasy "[ngseasy]:Config file name [${configfile_name}] detected" ${config_run_log}
fi

else
	working_dir="${config_directory_path}"
	logger_ngseasy "[ngseasy]:Path to config file directory detected as [${working_dir}]" ${config_run_log}
	logger_ngseasy "[ngseasy]:Setting Path to config file" ${config_run_log}
	logger_ngseasy "[ngseasy]:Config file location set to [${working_dir}]" ${config_run_log}
	logger_ngseasy "[ngseasy]:Moving to Config file location [${working_dir}] to make life easy" ${config_run_log}

	# move to location of config file
	cd ${working_dir}

	# check if file exists
	configfile_name=`basename ${config_tsv}`

if [[ ! -e "./${configfile_name}" ]]; then
	logger_ngseasy "[ngseasy]:ERROR:Config file [${config_tsv}] does not exist. Exiting" ${config_run_log}
	sleep 1s
	exit 1
else
	logger_ngseasy "[ngseasy]:Config file name [${configfile_name}] detected" ${config_run_log}
fi

fi

############################################################################################
## split config file
###########################################################################################
split_config $config_tsv

############################################################################################
## run ngseasy bsub for each individual config file
###########################################################################################
for file in  ${config_file}_*
 do
     logger_ngseasy "[NGSEASY_LSF]:bsub -o \"${project_directory}/run_logs/ngseasy_lsf_${file}.job.out\" -e \"${project_directory}/run_logs/ngseasy_lsf_${file}.job.err\" \"sudo /nfs/ngseasy/bin/ngseasy -c $file -d ${project_directory}\" "  
     bsub -o "${project_directory}/run_logs/ngseasy_lsf_${file}.job.out" -e "${project_directory}/run_logs/ngseasy_lsf_${file}.job.err" "sudo /nfs/ngseasy/bin/ngseasy -c $file -d ${project_directory}" 
	
 done

